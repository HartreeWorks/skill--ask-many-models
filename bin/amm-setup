#!/usr/bin/env bash
#
# amm-setup - Interactive setup wizard for Ask Many Models
#
# Guides users through:
# 1. Installing Node dependencies
# 2. Configuring API keys
# 3. Installing CLI tools (gum, jq)
# 4. Adding amm to PATH
#

set -euo pipefail

# Handle Ctrl+C gracefully
trap 'echo ""; echo "Setup cancelled."; exit 130' INT

# Colours and formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No colour

SKILL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SETUP_STATE="$SKILL_DIR/data/setup-state.json"
ENV_FILE="$SKILL_DIR/.env"

# Load nvm for node/yarn access
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"

# Helper functions
print_header() {
    echo ""
    echo -e "${CYAN}┌─────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│${NC}  ${BOLD}$1${NC}"
    if [[ -n "${2:-}" ]]; then
        echo -e "${CYAN}│${NC}"
        echo -e "${CYAN}│${NC}  ${DIM}$2${NC}"
    fi
    echo -e "${CYAN}└─────────────────────────────────────────────────────┘${NC}"
    echo ""
}

print_step() {
    echo -e "\n${BOLD}Step $1:${NC} $2\n"
}

print_success() {
    echo -e "  ${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "  ${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "  ${RED}✗${NC} $1"
}

print_info() {
    echo -e "  ${DIM}$1${NC}"
}

# Check if a command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Update setup state
update_setup_state() {
    local key="$1"
    local value="$2"

    if [[ ! -f "$SETUP_STATE" ]]; then
        echo '{"setup_complete":false,"setup_version":1,"completed_steps":[],"api_keys_configured":[],"path_configured":false}' > "$SETUP_STATE"
    fi

    # Use jq to update the state
    local tmp=$(mktemp)
    jq "$key = $value" "$SETUP_STATE" > "$tmp" && mv "$tmp" "$SETUP_STATE"
}

add_completed_step() {
    local step="$1"
    local tmp=$(mktemp)
    jq ".completed_steps += [\"$step\"] | .completed_steps |= unique" "$SETUP_STATE" > "$tmp" && mv "$tmp" "$SETUP_STATE"
}

add_configured_key() {
    local provider="$1"
    local tmp=$(mktemp)
    jq ".api_keys_configured += [\"$provider\"] | .api_keys_configured |= unique" "$SETUP_STATE" > "$tmp" && mv "$tmp" "$SETUP_STATE"
}

# Check if step is already completed
step_completed() {
    local step="$1"
    jq -e ".completed_steps | index(\"$step\")" "$SETUP_STATE" &> /dev/null
}

# Get shell profile file
get_shell_profile() {
    local shell_name=$(basename "$SHELL")
    case "$shell_name" in
        zsh)
            echo "$HOME/.zshrc"
            ;;
        bash)
            if [[ -f "$HOME/.bash_profile" ]]; then
                echo "$HOME/.bash_profile"
            else
                echo "$HOME/.bashrc"
            fi
            ;;
        fish)
            echo "$HOME/.config/fish/config.fish"
            ;;
        *)
            echo "$HOME/.profile"
            ;;
    esac
}

# Check if amm is in PATH
amm_in_path() {
    command_exists amm && [[ "$(which amm)" == "$SKILL_DIR/bin/amm" ]]
}

# Validate a single API key
validate_key() {
    local provider="$1"
    cd "$SKILL_DIR"
    local result=$(npx tsx scripts/validate-keys.ts "$provider" 2>/dev/null || echo '[]')
    echo "$result" | jq -r '.[0].valid' 2>/dev/null || echo "false"
}

# ============================================================================
# Main setup flow
# ============================================================================

main() {
    # Check for required tools first
    if ! command_exists gum; then
        echo -e "${RED}Error:${NC} gum is required for the setup wizard."
        echo "Install it with: brew install gum"
        exit 1
    fi

    if ! command_exists jq; then
        echo -e "${RED}Error:${NC} jq is required for the setup wizard."
        echo "Install it with: brew install jq"
        exit 1
    fi

    print_header "Welcome to Ask Many Models!" "Let's get you set up. This will take ~2 minutes."

    # Determine what needs to be done
    local needs_deps=false
    local needs_keys=false
    local needs_tools=false
    local needs_path=false

    # Check Node dependencies
    if [[ ! -d "$SKILL_DIR/node_modules" ]]; then
        needs_deps=true
    fi

    # Check .env file
    if [[ ! -f "$ENV_FILE" ]]; then
        needs_keys=true
    fi

    # Check CLI tools
    if ! command_exists gum || ! command_exists jq; then
        needs_tools=true
    fi

    # Check PATH
    if ! amm_in_path; then
        needs_path=true
    fi

    local step_num=1
    local total_steps=0
    [[ "$needs_deps" == "true" ]] && ((total_steps++))
    [[ "$needs_keys" == "true" ]] && ((total_steps++))
    ((total_steps++))  # Always check tools
    ((total_steps++))  # Always check PATH

    # ========================================================================
    # Step 1: Install Node dependencies
    # ========================================================================
    if [[ "$needs_deps" == "true" ]]; then
        print_step "$step_num/$total_steps" "Installing dependencies..."

        cd "$SKILL_DIR"
        if yarn install --silent 2>/dev/null; then
            print_success "Node packages installed"
            add_completed_step "dependencies"
        else
            print_error "Failed to install Node packages"
            echo "  Try running: cd $SKILL_DIR && yarn install"
            exit 1
        fi
        ((step_num++))
    fi

    # ========================================================================
    # Step 2: Configure API keys
    # ========================================================================
    if [[ "$needs_keys" == "true" ]] || ! step_completed "api_keys"; then
        print_step "$step_num/$total_steps" "Setting up API keys"

        echo "  Which providers do you want to use?"
        echo ""

        # Multi-select providers
        PROVIDERS=$(gum choose --no-limit --height=6 \
            "OpenAI (GPT-5.2)" \
            "Google (Gemini)" \
            "xAI (Grok)" \
            "Anthropic (Claude) - optional" || true)

        if [[ -z "$PROVIDERS" ]]; then
            print_warning "No providers selected. You'll need at least one API key."
            PROVIDERS="OpenAI (GPT-5.2)"
        fi

        # Create .env file if it doesn't exist
        if [[ ! -f "$ENV_FILE" ]]; then
            cat > "$ENV_FILE" << 'EOF'
# Ask Many Models API Keys
# Generated by amm-setup

EOF
        fi

        echo ""

        # Configure each selected provider
        if echo "$PROVIDERS" | grep -q "OpenAI"; then
            echo -e "  ${BOLD}OpenAI API Key${NC}"
            print_info "Get one at: https://platform.openai.com/api-keys"

            OPENAI_KEY=$(gum input --placeholder "sk-proj-..." --width=80 --password || true)

            if [[ -n "$OPENAI_KEY" && "$OPENAI_KEY" != "sk-proj-..." ]]; then
                # Remove existing key if present
                grep -v "^OPENAI_API_KEY=" "$ENV_FILE" > "$ENV_FILE.tmp" || true
                mv "$ENV_FILE.tmp" "$ENV_FILE"
                echo "OPENAI_API_KEY=$OPENAI_KEY" >> "$ENV_FILE"

                # Validate
                echo -n "  Validating... "
                if [[ $(validate_key "openai") == "true" ]]; then
                    echo -e "${GREEN}✓${NC}"
                    add_configured_key "openai"
                else
                    echo -e "${YELLOW}⚠ Could not validate (may still work)${NC}"
                fi
            fi
            echo ""
        fi

        if echo "$PROVIDERS" | grep -q "Google"; then
            echo -e "  ${BOLD}Google AI Studio API Key${NC}"
            print_info "Get one at: https://aistudio.google.com/apikey"

            GOOGLE_KEY=$(gum input --placeholder "AIza..." --width=80 --password || true)

            if [[ -n "$GOOGLE_KEY" && "$GOOGLE_KEY" != "AIza..." ]]; then
                grep -v "^GOOGLE_GENERATIVE_AI_API_KEY=" "$ENV_FILE" > "$ENV_FILE.tmp" || true
                grep -v "^GEMINI_API_KEY=" "$ENV_FILE.tmp" > "$ENV_FILE" || true
                echo "GOOGLE_GENERATIVE_AI_API_KEY=$GOOGLE_KEY" >> "$ENV_FILE"
                echo "GEMINI_API_KEY=$GOOGLE_KEY" >> "$ENV_FILE"

                echo -n "  Validating... "
                if [[ $(validate_key "google") == "true" ]]; then
                    echo -e "${GREEN}✓${NC}"
                    add_configured_key "google"
                else
                    echo -e "${YELLOW}⚠ Could not validate (may still work)${NC}"
                fi
            fi
            echo ""
        fi

        if echo "$PROVIDERS" | grep -q "xAI"; then
            echo -e "  ${BOLD}xAI API Key${NC}"
            print_info "Get one at: https://console.x.ai"

            XAI_KEY=$(gum input --placeholder "xai-..." --width=80 --password || true)

            if [[ -n "$XAI_KEY" && "$XAI_KEY" != "xai-..." ]]; then
                grep -v "^XAI_API_KEY=" "$ENV_FILE" > "$ENV_FILE.tmp" || true
                mv "$ENV_FILE.tmp" "$ENV_FILE"
                echo "XAI_API_KEY=$XAI_KEY" >> "$ENV_FILE"

                echo -n "  Validating... "
                if [[ $(validate_key "xai") == "true" ]]; then
                    echo -e "${GREEN}✓${NC}"
                    add_configured_key "xai"
                else
                    echo -e "${YELLOW}⚠ Could not validate (may still work)${NC}"
                fi
            fi
            echo ""
        fi

        if echo "$PROVIDERS" | grep -q "Anthropic"; then
            echo -e "  ${BOLD}Anthropic API Key${NC}"
            print_info "Get one at: https://console.anthropic.com/settings/keys"
            print_info "(Optional - you're already using Claude Code)"

            ANTHROPIC_KEY=$(gum input --placeholder "sk-ant-..." --width=80 --password || true)

            if [[ -n "$ANTHROPIC_KEY" && "$ANTHROPIC_KEY" != "sk-ant-..." ]]; then
                grep -v "^ANTHROPIC_API_KEY=" "$ENV_FILE" > "$ENV_FILE.tmp" || true
                mv "$ENV_FILE.tmp" "$ENV_FILE"
                echo "ANTHROPIC_API_KEY=$ANTHROPIC_KEY" >> "$ENV_FILE"

                echo -n "  Validating... "
                if [[ $(validate_key "anthropic") == "true" ]]; then
                    echo -e "${GREEN}✓${NC}"
                    add_configured_key "anthropic"
                else
                    echo -e "${YELLOW}⚠ Could not validate (may still work)${NC}"
                fi
            fi
            echo ""
        fi

        add_completed_step "api_keys"
        ((step_num++))
    else
        ((step_num++))
    fi

    # ========================================================================
    # Step 3: Check CLI tools
    # ========================================================================
    print_step "$step_num/$total_steps" "Checking CLI tools"

    if command_exists gum; then
        print_success "gum installed"
    else
        print_warning "gum not installed"
        if gum confirm "Install gum now?"; then
            brew install gum && print_success "gum installed"
        fi
    fi

    if command_exists jq; then
        print_success "jq installed"
    else
        print_warning "jq not installed"
        if gum confirm "Install jq now?"; then
            brew install jq && print_success "jq installed"
        fi
    fi

    if command_exists fzf; then
        print_success "fzf installed (optional)"
    else
        print_info "fzf not installed (optional - enables file search)"
        if gum confirm "Install fzf now? (optional)"; then
            brew install fzf && print_success "fzf installed"
        fi
    fi

    add_completed_step "cli_tools"
    ((step_num++))

    # ========================================================================
    # Step 4: Add to PATH
    # ========================================================================
    print_step "$step_num/$total_steps" "Adding 'amm' to your terminal"

    if amm_in_path; then
        print_success "amm already in PATH"
        update_setup_state ".path_configured" "true"
    else
        local shell_profile=$(get_shell_profile)
        local path_line="export PATH=\"\$PATH:$SKILL_DIR/bin\""

        # Check if already in profile but not loaded
        if grep -q "$SKILL_DIR/bin" "$shell_profile" 2>/dev/null; then
            print_warning "PATH entry exists in $shell_profile but not loaded"
            echo ""
            echo "  Run: source $shell_profile"
        else
            echo ""
            if gum confirm "Add amm to your PATH?"; then
                echo "" >> "$shell_profile"
                echo "# Ask Many Models CLI" >> "$shell_profile"
                echo "$path_line" >> "$shell_profile"

                print_success "Added to $shell_profile"
                echo ""
                echo -e "  ${DIM}Added:${NC}"
                echo -e "    ${DIM}$path_line${NC}"
                echo ""
                echo -e "  Run: ${BOLD}source $shell_profile${NC} (or restart terminal)"

                update_setup_state ".path_configured" "true"
            else
                print_info "Skipped. You can run amm directly:"
                echo "    $SKILL_DIR/bin/amm"
            fi
        fi
    fi

    add_completed_step "path"

    # ========================================================================
    # Complete!
    # ========================================================================
    update_setup_state ".setup_complete" "true"

    echo ""
    echo -e "${CYAN}┌─────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│${NC}  ${GREEN}✅ Setup complete!${NC}"
    echo -e "${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  Try it now:"
    echo -e "${CYAN}│${NC}    ${BOLD}amm \"What's the best programming language?\"${NC}"
    echo -e "${CYAN}│${NC}"
    echo -e "${CYAN}│${NC}  Or via Claude Code:"
    echo -e "${CYAN}│${NC}    ${BOLD}/amm \"Your question here\"${NC}"
    echo -e "${CYAN}└─────────────────────────────────────────────────────┘${NC}"
    echo ""
}

# Run with skip option for testing
if [[ "${1:-}" == "--status" ]]; then
    if [[ -f "$SETUP_STATE" ]]; then
        cat "$SETUP_STATE"
    else
        echo '{"setup_complete":false}'
    fi
    exit 0
fi

if [[ "${1:-}" == "--reset" ]]; then
    rm -f "$SETUP_STATE"
    echo "Setup state reset."
    exit 0
fi

main "$@"

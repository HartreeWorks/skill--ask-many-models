#!/usr/bin/env bash
#
# amm - Ask Many Models CLI
#
# A fast CLI wrapper for querying multiple AI models in parallel.
# Uses gum for interactive model selection with presets and individual models.
#
# Usage:
#   amm "What is the meaning of life?"
#   amm --quick "Explain X"
#   amm --no-synthesise "Just get responses"
#

set -euo pipefail

# Load nvm for node/yarn access
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"

SKILL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_FILE="$SKILL_DIR/config.json"
DEFAULTS_FILE="$SKILL_DIR/data/user-defaults.json"
RESPONSES_DIR="$SKILL_DIR/multi-model-responses"

# Parse arguments
SYNTHESISE=true
SKIP_SELECT=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-synthesise|--no-synthesize)
            SYNTHESISE=false
            shift
            ;;
        --quick|-q)
            SKIP_SELECT=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    echo "Usage: amm [options] \"Your prompt here\""
    echo ""
    echo "Options:"
    echo "  --quick, -q        Skip model selection, use defaults"
    echo "  --no-synthesise    Skip synthesis step"
    echo ""
    exit 1
fi

PROMPT="$1"

# Read default models from user-defaults.json
DEFAULT_MODELS=$(jq -r '.default_models[]' "$DEFAULTS_FILE")
DEFAULT_MODELS_CSV=$(echo "$DEFAULT_MODELS" | tr '\n' ',' | sed 's/,$//')

# Get preset info
QUICK_MODELS=$(jq -r '.presets.quick.models | join(",")' "$CONFIG_FILE")
FRONTIER_MODELS=$(jq -r '.presets.frontier.models | join(",")' "$CONFIG_FILE")
COMPREHENSIVE_MODELS=$(jq -r '.presets.comprehensive.models | join(",")' "$CONFIG_FILE")

# Read all available API models from config.json (exclude browser models)
ALL_MODELS=$(jq -r '.models | to_entries | map(select(.value.type == "api")) | .[].key' "$CONFIG_FILE")

if [[ "$SKIP_SELECT" == "true" ]]; then
    MODELS_CSV="$DEFAULT_MODELS_CSV"
else
    # Build options: presets first, then separator, then individual models
    echo "Select mode or models:"
    echo "  â†‘/â†“ navigate  â€¢  space toggle  â€¢  enter confirm"
    echo ""

    # Create options array with presets first
    OPTIONS=(
        "âš¡ Defaults ($DEFAULT_MODELS_CSV)"
        "ðŸš€ Quick ($QUICK_MODELS)"
        "ðŸŽ¯ Frontier ($FRONTIER_MODELS)"
        "ðŸ“Š Comprehensive ($COMPREHENSIVE_MODELS)"
        "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    )

    # Add individual models
    for model in $ALL_MODELS; do
        OPTIONS+=("$model")
    done

    # Run gum choose (single select for presets, but allow drilling into individual)
    SELECTION=$(gum choose --height=18 "${OPTIONS[@]}" || true)

    if [[ -z "$SELECTION" ]]; then
        echo "No selection made, using defaults."
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    elif [[ "$SELECTION" == "âš¡ Defaults"* ]]; then
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    elif [[ "$SELECTION" == "ðŸš€ Quick"* ]]; then
        MODELS_CSV="$QUICK_MODELS"
    elif [[ "$SELECTION" == "ðŸŽ¯ Frontier"* ]]; then
        MODELS_CSV="$FRONTIER_MODELS"
    elif [[ "$SELECTION" == "ðŸ“Š Comprehensive"* ]]; then
        MODELS_CSV="$COMPREHENSIVE_MODELS"
    elif [[ "$SELECTION" == "â”€â”€â”€"* ]]; then
        echo "That's a separator. Using defaults."
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    else
        # User selected an individual model - let them pick more
        echo ""
        echo "Select additional models (or just press enter):"

        # Build options with the first selection pre-selected
        SELECTED_ARGS="--selected=\"$SELECTION\""

        MORE_SELECTIONS=$(eval "gum choose --no-limit --height=15 $SELECTED_ARGS $ALL_MODELS" || true)

        if [[ -z "$MORE_SELECTIONS" ]]; then
            MODELS_CSV="$SELECTION"
        else
            MODELS_CSV=$(echo "$MORE_SELECTIONS" | tr '\n' ',' | sed 's/,$//')
        fi
    fi
fi

# Generate output file path
TIMESTAMP=$(date +%Y-%m-%d-%H%M)
SLUG=$(echo "$PROMPT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-50)
LIVE_FILE="$RESPONSES_DIR/${TIMESTAMP}-${SLUG}.md"

echo ""
echo "Querying: $MODELS_CSV"
echo "Output: $LIVE_FILE"
echo ""

# Build the query command
QUERY_CMD="yarn --cwd \"$SKILL_DIR\" query --models \"$MODELS_CSV\" --live-file \"$LIVE_FILE\""

if [[ "$SYNTHESISE" == "true" ]]; then
    QUERY_CMD="$QUERY_CMD --synthesise"
fi

QUERY_CMD="$QUERY_CMD \"$PROMPT\""

# Run the query
eval "$QUERY_CMD"

# Open the file
echo ""
echo "Opening results..."
open "$LIVE_FILE"

#!/usr/bin/env bash
#
# amm - Ask Many Models CLI
#
# A fast CLI wrapper for querying multiple AI models in parallel.
# Uses gum for interactive model selection with presets and individual models.
#
# Usage:
#   amm "What is the meaning of life?"
#   amm --quick "Explain X"
#   amm --no-synthesise "Just get responses"
#

set -euo pipefail

# Load nvm for node/yarn access
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"

SKILL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_FILE="$SKILL_DIR/config.json"
DEFAULTS_FILE="$SKILL_DIR/data/user-defaults.json"
RESPONSES_DIR="$SKILL_DIR/multi-model-responses"

# Parse arguments
SYNTHESISE=true
SKIP_SELECT=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-synthesise|--no-synthesize)
            SYNTHESISE=false
            shift
            ;;
        --quick|-q)
            SKIP_SELECT=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    # No prompt provided - use gum to get interactive input
    PROMPT=$(gum write --placeholder "Enter your prompt..." --width=80 --height=6)
    if [[ -z "$PROMPT" ]]; then
        echo "No prompt entered."
        exit 1
    fi
else
    PROMPT="$1"
fi

# Read default models from user-defaults.json
DEFAULT_MODELS=$(jq -r '.default_models[]' "$DEFAULTS_FILE")
DEFAULT_MODELS_CSV=$(echo "$DEFAULT_MODELS" | tr '\n' ',' | sed 's/,$//')

# Get preset info
QUICK_MODELS=$(jq -r '.presets.quick.models | join(",")' "$CONFIG_FILE")
COMPREHENSIVE_MODELS=$(jq -r '.presets.comprehensive.models | join(",")' "$CONFIG_FILE")

# Read all available API models from config.json (exclude browser models)
ALL_MODELS=$(jq -r '.models | to_entries | map(select(.value.type == "api")) | .[].key' "$CONFIG_FILE")

if [[ "$SKIP_SELECT" == "true" ]]; then
    MODELS_CSV="$DEFAULT_MODELS_CSV"
else
    # Convert ALL_MODELS to array for proper argument handling
    ALL_MODELS_ARRAY=()
    while IFS= read -r model; do
        [[ -n "$model" ]] && ALL_MODELS_ARRAY+=("$model")
    done <<< "$ALL_MODELS"

    # Show the prompt before model selection
    echo ""
    gum style --foreground 212 "Prompt:"
    echo "$PROMPT"
    echo ""

    # First screen: presets or pick individual models
    PRESET_OPTIONS=(
        "âš¡ Defaults ($DEFAULT_MODELS_CSV)"
        "ðŸš€ Quick ($QUICK_MODELS)"
        "ðŸ“Š Comprehensive (all default models + GPT 5.2 Pro)"
        "ðŸ”§ Pick individual models..."
    )

    SELECTION=$(gum choose --height=10 "${PRESET_OPTIONS[@]}" || true)

    if [[ -z "$SELECTION" ]]; then
        echo "No selection made, using defaults."
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    elif [[ "$SELECTION" == "âš¡ Defaults"* ]]; then
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    elif [[ "$SELECTION" == "ðŸš€ Quick"* ]]; then
        MODELS_CSV="$QUICK_MODELS"
    elif [[ "$SELECTION" == "ðŸ“Š Comprehensive"* ]]; then
        MODELS_CSV="$COMPREHENSIVE_MODELS"
    elif [[ "$SELECTION" == "ðŸ”§ Pick"* ]]; then
        # Show individual models with multi-select
        echo ""
        echo "Select models (space to toggle, enter to confirm):"

        MODEL_SELECTIONS=$(gum choose --no-limit --height=15 "${ALL_MODELS_ARRAY[@]}" || true)

        if [[ -z "$MODEL_SELECTIONS" ]]; then
            echo "No models selected, using defaults."
            MODELS_CSV="$DEFAULT_MODELS_CSV"
        else
            MODELS_CSV=$(echo "$MODEL_SELECTIONS" | tr '\n' ',' | sed 's/,$//')
        fi
    fi
fi

# Generate output file path
TIMESTAMP=$(date +%Y-%m-%d-%H%M)
SLUG=$(echo "$PROMPT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-50)
LIVE_FILE="$RESPONSES_DIR/${TIMESTAMP}-${SLUG}.md"

echo ""
echo "Querying: $MODELS_CSV"
echo "Output: $LIVE_FILE"
echo ""

# Build the query command as an array to properly handle special characters
QUERY_ARGS=(
    --cwd "$SKILL_DIR"
    query
    --models "$MODELS_CSV"
    --live-file "$LIVE_FILE"
)

if [[ "$SYNTHESISE" == "true" ]]; then
    QUERY_ARGS+=(--synthesise)
fi

# Add prompt as the final argument (preserves quotes and special chars)
QUERY_ARGS+=("$PROMPT")

# Run the query
yarn "${QUERY_ARGS[@]}"

# Open the file
echo ""
echo "Opening results..."
open "$LIVE_FILE"

#!/usr/bin/env bash
#
# amm - Ask Many Models CLI
#
# A fast CLI wrapper for querying multiple AI models in parallel.
# Uses gum for interactive model selection with presets and individual models.
#
# Usage:
#   amm "What is the meaning of life?"
#   amm --quick "Explain X"
#   amm --no-synthesise "Just get responses"
#

set -euo pipefail

# Handle Ctrl+C gracefully
trap 'echo ""; echo "Cancelled."; exit 130' INT

SKILL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Check if setup is complete
SETUP_STATE="$SKILL_DIR/data/setup-state.json"
if [[ ! -f "$SETUP_STATE" ]] || [[ "$(jq -r '.setup_complete' "$SETUP_STATE" 2>/dev/null)" != "true" ]]; then
    "$SKILL_DIR/bin/amm-setup"
    # After setup, check if it completed successfully
    if [[ "$(jq -r '.setup_complete' "$SETUP_STATE" 2>/dev/null)" != "true" ]]; then
        echo "Setup incomplete. Run 'amm' again to continue setup."
        exit 1
    fi
fi

# Load nvm for node/yarn access
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"

CONFIG_FILE="$SKILL_DIR/config.json"
DEFAULTS_FILE="$SKILL_DIR/data/user-defaults.json"
RESPONSES_DIR="$SKILL_DIR/multi-model-responses"

# Check output format preference
OUTPUT_FORMAT=$(jq -r '.output_format // empty' "$DEFAULTS_FILE" 2>/dev/null)
if [[ -z "$OUTPUT_FORMAT" ]]; then
    echo ""
    gum style --foreground 212 "Output format preference"
    echo "How would you like to view results?"
    echo ""
    OUTPUT_FORMAT=$(gum choose "both (Recommended)" "html" "markdown")
    OUTPUT_FORMAT="${OUTPUT_FORMAT%% *}"  # Strip " (Recommended)" suffix
    # Save to user-defaults.json
    jq --arg fmt "$OUTPUT_FORMAT" '.output_format = $fmt' "$DEFAULTS_FILE" > "$DEFAULTS_FILE.tmp" && mv "$DEFAULTS_FILE.tmp" "$DEFAULTS_FILE"
    echo "Saved preference: $OUTPUT_FORMAT"
    echo ""
fi

# Parse arguments
SYNTHESISE=true
SKIP_SELECT=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-synthesise|--no-synthesize)
            SYNTHESISE=false
            shift
            ;;
        --quick|-q)
            SKIP_SELECT=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    # No prompt provided - use gum to get interactive input
    PROMPT=$(gum write --placeholder "Enter your prompt..." --width=80 --height=6)
    if [[ -z "$PROMPT" ]]; then
        echo "No prompt entered."
        exit 1
    fi
else
    PROMPT="$1"
fi

# Validate prompt is not empty or whitespace-only
PROMPT_TRIMMED="${PROMPT#"${PROMPT%%[![:space:]]*}"}"
PROMPT_TRIMMED="${PROMPT_TRIMMED%"${PROMPT_TRIMMED##*[![:space:]]}"}"
if [[ -z "$PROMPT_TRIMMED" ]]; then
    echo "Error: Prompt cannot be empty."
    exit 1
fi

# Read default models from user-defaults.json
DEFAULT_MODELS=$(jq -r '.default_models[]' "$DEFAULTS_FILE")
DEFAULT_MODELS_CSV=$(echo "$DEFAULT_MODELS" | tr '\n' ',' | sed 's/,$//')

# Get preset info
QUICK_MODELS=$(jq -r '.presets.quick.models | join(",")' "$CONFIG_FILE")
COMPREHENSIVE_MODELS=$(jq -r '.presets.comprehensive.models | join(",")' "$CONFIG_FILE")
DEEP_RESEARCH_MODELS=$(jq -r '.presets["deep-research"].models | join(",")' "$CONFIG_FILE")
COMPREHENSIVE_DEEP_MODELS=$(jq -r '.presets["comprehensive-deep"].models | join(",")' "$CONFIG_FILE")

# Read all available API models from config.json (exclude browser models)
ALL_MODELS=$(jq -r '.models | to_entries | map(select(.value.type == "api")) | .[].key' "$CONFIG_FILE")

if [[ "$SKIP_SELECT" == "true" ]]; then
    MODELS_CSV="$DEFAULT_MODELS_CSV"
else
    # Convert ALL_MODELS to array for proper argument handling
    ALL_MODELS_ARRAY=()
    while IFS= read -r model; do
        [[ -n "$model" ]] && ALL_MODELS_ARRAY+=("$model")
    done <<< "$ALL_MODELS"

    # Show the prompt before model selection
    echo ""
    gum style --foreground 212 "Prompt:"
    echo "$PROMPT"
    echo ""

    # First screen: presets or pick individual models
    PRESET_OPTIONS=(
        "âš¡ Defaults ($DEFAULT_MODELS_CSV)"
        "ðŸš€ Quick ($QUICK_MODELS)"
        "ðŸ“Š Comprehensive (all default models + GPT 5.2 Pro)"
        "ðŸ”¬ Deep Research + GPT 5.2 Pro (20-40 min)"
        "ðŸ’« Comprehensive + Deep Research"
        "ðŸ”§ Pick individual models..."
    )

    SELECTION=$(gum choose --height=10 "${PRESET_OPTIONS[@]}" || true)

    if [[ -z "$SELECTION" ]]; then
        echo "No selection made, using defaults."
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    elif [[ "$SELECTION" == "âš¡ Defaults"* ]]; then
        MODELS_CSV="$DEFAULT_MODELS_CSV"
    elif [[ "$SELECTION" == "ðŸš€ Quick"* ]]; then
        MODELS_CSV="$QUICK_MODELS"
    elif [[ "$SELECTION" == "ðŸ“Š Comprehensive (all"* ]]; then
        MODELS_CSV="$COMPREHENSIVE_MODELS"
    elif [[ "$SELECTION" == "ðŸ”¬ Deep Research"* ]]; then
        MODELS_CSV="$DEEP_RESEARCH_MODELS"
        IS_DEEP_RESEARCH=true
    elif [[ "$SELECTION" == "ðŸ’« Comprehensive"* ]]; then
        MODELS_CSV="$COMPREHENSIVE_DEEP_MODELS"
        IS_DEEP_RESEARCH=true
    elif [[ "$SELECTION" == "ðŸ”§ Pick"* ]]; then
        # Show individual models with multi-select
        echo ""
        echo "Select models (space to toggle, enter to confirm):"

        MODEL_SELECTIONS=$(gum choose --no-limit --height=15 "${ALL_MODELS_ARRAY[@]}" || true)

        if [[ -z "$MODEL_SELECTIONS" ]]; then
            echo "No models selected, using defaults."
            MODELS_CSV="$DEFAULT_MODELS_CSV"
        else
            MODELS_CSV=$(echo "$MODEL_SELECTIONS" | tr '\n' ',' | sed 's/,$//')
            # Check if any selected models are deep research
            if echo "$MODEL_SELECTIONS" | grep -q "deep-research"; then
                IS_DEEP_RESEARCH=true
            fi
        fi
    fi
fi

# Deep research handling: show warning and context picker
CONTEXT_FILE=""
CONTEXT_FILES=()
CONTEXT_DESCRIPTIONS=()
if [[ "${IS_DEEP_RESEARCH:-false}" == "true" ]]; then
    echo ""
    gum style --foreground 214 --bold "âš ï¸  Deep Research Mode"
    echo "Deep research models take 20-40 minutes per model."
    echo "Quick models will return results in ~30 seconds."

    # Loop for adding multiple context sources
    while true; do
        echo ""

        # Show accumulated context if any
        if [[ ${#CONTEXT_DESCRIPTIONS[@]} -gt 0 ]]; then
            gum style --foreground 82 "Context added:"
            for desc in "${CONTEXT_DESCRIPTIONS[@]}"; do
                echo "  âœ“ $desc"
            done
            echo ""
        fi

        gum style --foreground 212 "Would you like to add context?"
        echo ""

        ADD_CONTEXT=$(gum choose --height=7 \
            "No, continue" \
            "Browse files (from home)" \
            "Paste or drag file path" \
            "Paste text directly" \
            "Search")

        case "$ADD_CONTEXT" in
            "No, continue"*)
                break
                ;;
            "Browse files"*)
                echo ""
                echo "Select a file:"
                gum style --faint "  â†’ to open folder | Enter to select | Esc to cancel"
                SELECTED=$(gum file --directory --file --height=15 "$HOME" || true)
                if [[ -n "$SELECTED" ]]; then
                    if [[ -d "$SELECTED" ]]; then
                        gum style --foreground 196 "Cannot use directory as context. Please select a file."
                    elif [[ -f "$SELECTED" ]]; then
                        # Check if it's a binary file
                        if file "$SELECTED" | grep -q "text"; then
                            CONTEXT_FILES+=("$SELECTED")
                            CONTEXT_DESCRIPTIONS+=("$SELECTED")
                        else
                            gum style --foreground 196 "Cannot use binary file as context. Please select a text file."
                        fi
                    fi
                fi
                ;;
            "Paste or drag"*)
                echo ""
                SELECTED=$(gum input --placeholder "Paste path or drag file here..." --width=80 || true)
                # Expand ~ to home directory
                SELECTED="${SELECTED/#\~/$HOME}"
                if [[ -n "$SELECTED" ]]; then
                    if [[ ! -e "$SELECTED" ]]; then
                        gum style --foreground 196 "File not found: $SELECTED"
                    elif [[ -d "$SELECTED" ]]; then
                        gum style --foreground 196 "Cannot use directory as context. Please specify a file."
                    elif [[ -f "$SELECTED" ]]; then
                        if file "$SELECTED" | grep -q "text"; then
                            CONTEXT_FILES+=("$SELECTED")
                            CONTEXT_DESCRIPTIONS+=("$SELECTED")
                        else
                            gum style --foreground 196 "Cannot use binary file as context. Please specify a text file."
                        fi
                    fi
                fi
                ;;
            "Paste text"*)
                echo ""
                echo "Paste your context text:"
                gum style --faint "  Paste with Cmd+V | Press Ctrl+D or Esc when done"
                PASTED_TEXT=$(gum write --placeholder "Paste context here..." --width=80 --height=10 || true)
                if [[ -n "$PASTED_TEXT" ]]; then
                    # Save to temp file (use $TMPDIR for macOS compatibility)
                    TEMP_FILE=$(mktemp "${TMPDIR:-/tmp}/amm-context-XXXXXX")
                    echo "$PASTED_TEXT" > "$TEMP_FILE"
                    CONTEXT_FILES+=("$TEMP_FILE")
                    CONTEXT_DESCRIPTIONS+=("Pasted text (${#PASTED_TEXT} chars)")
                fi
                ;;
            "Search")
                if command -v fzf &> /dev/null; then
                    echo ""
                    echo "Searching files (type to filter, Enter to select, Esc to cancel):"
                    SELECTED=$(find "$HOME" -type f \( -name "*.md" -o -name "*.txt" -o -name "*.pdf" \) 2>/dev/null | fzf --height=15 --preview 'head -20 {}' || true)
                    if [[ -n "$SELECTED" && -f "$SELECTED" ]]; then
                        CONTEXT_FILES+=("$SELECTED")
                        CONTEXT_DESCRIPTIONS+=("$SELECTED")
                    fi
                else
                    echo ""
                    gum style --foreground 214 "Search requires 'fzf'. Install with: brew install fzf"
                    echo "Falling back to file browser..."
                    gum style --faint "  â†’ to open folder | Enter to select | Esc to cancel"
                    SELECTED=$(gum file --directory --file --height=15 "$HOME" || true)
                    if [[ -n "$SELECTED" ]]; then
                        if [[ -d "$SELECTED" ]]; then
                            gum style --foreground 196 "Cannot use directory as context. Please select a file."
                        elif [[ -f "$SELECTED" ]]; then
                            if file "$SELECTED" | grep -q "text"; then
                                CONTEXT_FILES+=("$SELECTED")
                                CONTEXT_DESCRIPTIONS+=("$SELECTED")
                            else
                                gum style --foreground 196 "Cannot use binary file as context. Please select a text file."
                            fi
                        fi
                    fi
                fi
                ;;
        esac
    done

    # Combine all context files into one if multiple were added
    if [[ ${#CONTEXT_FILES[@]} -gt 0 ]]; then
        if [[ ${#CONTEXT_FILES[@]} -eq 1 ]]; then
            CONTEXT_FILE="${CONTEXT_FILES[0]}"
        else
            # Merge multiple context files
            CONTEXT_FILE=$(mktemp "${TMPDIR:-/tmp}/amm-context-merged-XXXXXX")
            for cf in "${CONTEXT_FILES[@]}"; do
                echo "--- From: $cf ---" >> "$CONTEXT_FILE"
                cat "$cf" >> "$CONTEXT_FILE"
                echo "" >> "$CONTEXT_FILE"
            done
        fi
    fi
fi

# Generate output file path
TIMESTAMP=$(date +%Y-%m-%d-%H%M)
SLUG=$(echo "$PROMPT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-50)
# Fallback if slug is empty (e.g., prompt was all unicode)
if [[ -z "$SLUG" ]]; then
    SLUG="query"
fi
LIVE_FILE="$RESPONSES_DIR/${TIMESTAMP}-${SLUG}.md"

echo ""
echo "Querying: $MODELS_CSV"
echo "Output: $LIVE_FILE"
echo ""

# Build the query command as an array to properly handle special characters
QUERY_ARGS=(
    --cwd "$SKILL_DIR"
    query
    --models "$MODELS_CSV"
    --live-file "$LIVE_FILE"
)

if [[ "$SYNTHESISE" == "true" ]]; then
    QUERY_ARGS+=(--synthesise)
fi

# Add output format
QUERY_ARGS+=(--output-format "$OUTPUT_FORMAT")

# Add context file if specified
if [[ -n "$CONTEXT_FILE" ]]; then
    QUERY_ARGS+=(--context "$CONTEXT_FILE")
fi

# Add prompt as the final argument (preserves quotes and special chars)
QUERY_ARGS+=("$PROMPT")

# Run the query
yarn "${QUERY_ARGS[@]}"

# Open the appropriate file(s)
echo ""
echo "Opening results..."
HTML_FILE="${LIVE_FILE%.md}.html"
if [[ "$OUTPUT_FORMAT" == "html" || "$OUTPUT_FORMAT" == "both" ]]; then
    open "$HTML_FILE"
fi
if [[ "$OUTPUT_FORMAT" == "markdown" || "$OUTPUT_FORMAT" == "both" ]]; then
    open "$LIVE_FILE"
fi
